@using MudBlazor;
@using DWIS.Docker.Models;
@using DWIS.Docker.Clients;
@inject DWISProject Project;
@inject DWISDockerClient DockerClient;


<MudTable Items="Project.Advisors.Apps" T="DWISApp">
    <ToolBarContent>
        <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="RefreshStatus"></MudIconButton>
        <MudSpacer />
        @if (_thinking)
        {
            <MudProgressCircular Color="Color.Info" Indeterminate="true" />
        }
    </ToolBarContent>
    <HeaderContent>
        <MudTh>App</MudTh>
        <MudTh>Container</MudTh>
        <MudTh>Start / Stop</MudTh>
        <MudTh>Port</MudTh>        
        <MudTh>Update</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd>
            <MudText>@context.AppName</MudText>
            @* <MudTextField @bind-Value="@context.AppName" Label="Container name"></MudTextField>           *@
        </MudTd>
        <MudTd>
            @if (!string.IsNullOrEmpty(context.ContainerID))
            {
                <MudIcon Icon="@Icons.Material.Filled.Check"></MudIcon>               
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Error"></MudIcon>
            }
        </MudTd>
        <MudTd>
            @if (context.Running)
            {
                <MudButton StartIcon="@Icons.Material.Filled.Stop" OnClick="async () =>{
                                    _thinking = true;
                                    await Stop(context);
                                    await InvokeAsync(RefreshStatus);}">
                </MudButton>
            }
            else
            {
                <MudButton StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="async () => {
                                    _thinking = true;
                                    await Start(context);
                                    await InvokeAsync(RefreshStatus);}"></MudButton>
            }
        </MudTd>
        <MudTd>
            <MudLink Target="_blank" Href=@GetAddress(context)>
                @context.HostPort                          
            </MudLink>
        </MudTd>
        <MudTd> 
            <MudButton StartIcon="@Icons.Material.Filled.Upgrade" OnClick="async () =>{
                                    _thinking = true;
                                    await Upgrade(context);
                                    await InvokeAsync(RefreshStatus);}">
            </MudButton>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {

    private bool _thinking;

    private string GetAddress(DWISApp app){
        return "http://localhost:" + app.HostPort;
    }

    protected async override Task OnInitializedAsync()
    {
        RefreshStatus();
        await base.OnInitializedAsync();
        _thinking = false;
    }

    private async void RefreshStatus()
    {
        if (DockerClient != null)
        {
            foreach (var app in Project.Advisors.Apps)
            {
                var info = await DockerClient.GetContainers(app.ImageNameNoTag + ":" + app.ImageTag);
                if (info != default && info.Any())
                {
                    app.ContainerID = info.First().id;
                    app.Running = info.First().running;
                    app.AppName = info.First().name;
                }
            }
        }
        _thinking = false;   
        await InvokeAsync(StateHasChanged);
    }


    private async Task Upgrade(DWISApp app)
    {
        await DockerClient.UpdateImage(app.ContainerID);
    }


    private async Task Stop(DWISApp app)
    {
        await DockerClient.StopContainer(app.ContainerID);
        app.Running = false;
    }

    private async Task Start(DWISApp app)
    {
        if (string.IsNullOrEmpty(app.ContainerID))
        {
            var envVariables = new List<(string key, string val)>
                {
                    (DWIS.Client.ReferenceImplementation.IDWISClientConfiguration.BLACKBOARD_IP_ENVIRONMENT_VARIABLE, "host.docker.internal")
                };

            if (!string.IsNullOrEmpty(app.HostPort))
            {
                app.ContainerID = await DockerClient.CreateContainer(app.ImageNameNoTag, app.ImageTag, null, null, app.AppName.Trim().Replace(" ", "-"), envVariables: envVariables, portsMapping: [(app.HostPort, app.ContainerPort)]);
            }
            else
            {
                app.ContainerID = await DockerClient.CreateContainer(app.ImageNameNoTag, app.ImageTag, null, null, app.AppName.Trim().Replace(" ", "-"), envVariables: envVariables);
            }
        }


        await DockerClient.StartContainer(app.ContainerID);
        app.Running = true;
    }

}
