@using MudBlazor
@using DWIS.Docker.Clients
@using DWIS.Docker.Models

@inject HubGroupDataManager Manager
@inject IDialogService DialogService
@inject DWISProject Project
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor httpContextAccessor
@* Required *@
<MudThemeProvider  />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudToolBar >

    <MudImage Src="img/DWIS-Industry-Group-Logo-5-31-21.png" Height="70" Style="margin-top:30px"></MudImage>

    <MudSpacer></MudSpacer>
    <MudText Typo="Typo.h3" >D-WIS Desktop</MudText>
    <MudSpacer></MudSpacer>

    <MudIconButton Icon="@Icons.Material.Outlined.Refresh" OnClick="Refresh" />
    @if (Desktop)
    {
        <MudIconButton Icon="@Icons.Material.Outlined.Settings" /> 

        <MudDivider  Vertical="true"  />
        <MudIconButton Icon="@Icons.Material.Outlined.Minimize" OnClick="OnMinimizeButtonClicked" />
        <MudIconButton Icon="@GetIcon()" OnClick="OnMaximizeButtonClicked" />
        <MudIconButton Icon="@Icons.Material.Outlined.Close" OnClick="OnQuitButtonClicked" /> 
    }
</MudToolBar>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-2"  Border Color="Color.Primary" >
     <MudSpacer />
    <MudTabPanel Text="Standard set-up" >
        <StandardSetUpComponent Project="Project"></StandardSetUpComponent>
    </MudTabPanel>
    <MudTabPanel Text="Blackboards">
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-2" Centered>
            <MudTabPanel Text="Blackboard Group view">
                <HubGroupDataComponent CopyToClipBoard="CopyToClipBoard" SelectFolder="SelectFolder" HubGroups="Manager.HubMonitoringData.HubGroups"></HubGroupDataComponent>
            </MudTabPanel>
            <MudTabPanel Text="Blackboard Container view">
                <BlackBoardComponent ContainersPerPort="Manager.GetContainersPerPort()"></BlackBoardComponent>
            </MudTabPanel>
        </MudTabs>
    </MudTabPanel>
     <MudTabPanel Text="DWIS Modules">
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-2" Centered>
            <MudTabPanel Text="Microstates">
                <MicrostatesComponent></MicrostatesComponent>
            </MudTabPanel>
            <MudTabPanel Text="Composer">
                <ComposerComponent></ComposerComponent>
            </MudTabPanel>
            <MudTabPanel Text="Scheduler">
                <SchedulerComponent></SchedulerComponent>
            </MudTabPanel>
            <MudTabPanel Text="Bridges">
                <BridgesComponent></BridgesComponent>
            </MudTabPanel>
        </MudTabs>
    </MudTabPanel>
    <MudTabPanel Text="Clients"></MudTabPanel>
    <MudTabPanel Text="Advisors"></MudTabPanel>
    <MudTabPanel Text="ADCS"></MudTabPanel>
    <MudSpacer />

</MudTabs>




@* <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mt-2" Centered>
    
    <MudTabPanel Text="Standard set-up">
       <StandardSetUpComponent></StandardSetUpComponent>
    </MudTabPanel>
   
    <MudTabPanel Text="Blackboard Group view">
        <HubGroupDataComponent CopyToClipBoard="CopyToClipBoard" SelectFolder="SelectFolder" HubGroups="Manager.HubMonitoringData.HubGroups"></HubGroupDataComponent>
    </MudTabPanel>
    <MudTabPanel Text="Blackboard Container view">
       <BlackBoardComponent ContainersPerPort="Manager.GetContainersPerPort()"></BlackBoardComponent>
    </MudTabPanel>
    <MudTabPanel Text="Microstates">
        <MicrostatesComponent></MicrostatesComponent>
    </MudTabPanel>
    <MudTabPanel Text="Composer">
        <ComposerComponent></ComposerComponent>
    </MudTabPanel>
    <MudTabPanel Text="Scheduler">
        <SchedulerComponent></SchedulerComponent>
    </MudTabPanel>    
    <MudTabPanel Text="Bridges">
        <BridgesComponent></BridgesComponent>
    </MudTabPanel>
</MudTabs> *@

<MudAppBar Color="Color.Info" Bottom="true">
    <MudText Typo="Typo.caption">@("Hub: " + Manager.HubAddress)</MudText>
    <MudSpacer></MudSpacer>
    @* <MudText Typo="Typo.caption">@("Docker: " + Manager.DockerURI)</MudText> *@
    <MudSpacer></MudSpacer>
    <MudIconButton Icon="@Icons.Material.Filled.Settings" OnClick="OpenSettingsDialogAsync" />
</MudAppBar>

    @code {


    protected override Task OnParametersSetAsync()
    {
        if (Project != null && string.IsNullOrEmpty(Project.BlackBoardHostIP))
        {
            var remoteIpAddress = httpContextAccessor.HttpContext?.Connection.RemoteIpAddress;
            if (remoteIpAddress != null)
            {
                // Optionally map to IPv4
               Project.BlackBoardHostIP = remoteIpAddress.MapToIPv4().ToString();
            }
        }
        return base.OnParametersSetAsync();
    }

    protected async override Task OnInitializedAsync()
    {

        await Manager.UpdateManagerData();
    }

    [Parameter]
    public bool Maximized { get; set; }

    [Parameter]
    public Action<string>? CopyToClipBoard { get; set; }

    [Parameter]
    public Func<string>? SelectFolder { get; set; }

    [Parameter]
    public EventCallback OnQuitButtonClicked { get; set; }
    [Parameter]
    public EventCallback OnMaximizeButtonClicked { get; set; }
    [Parameter]
    public EventCallback OnMinimizeButtonClicked { get; set; }

    [Parameter]
    public bool Desktop { get; set; }

    private async void Refresh()
    {
        await Manager.UpdateManagerData();
        await InvokeAsync(StateHasChanged);
    }

    private string GetIcon() 
    {
        if (Maximized) { return Icons.Material.Outlined.Layers; }
        else return Icons.Material.Outlined.CropSquare;
    }

     private Task OpenSettingsDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };

        return DialogService.ShowAsync<DockerClientEditor>("Docker engine", options);
    }


    // private async void onQuitButtonClicked(MouseEventArgs args)
    // {
    //     await OnQuitButtonClicked.InvokeAsync();
    // }
}
