@using MudBlazor;
@using DWIS.Docker.Models;
@using DWIS.Docker.Clients;
@inject StandardSetUp SetUp;
@inject DWISDockerClient _client;
@inject DWISModulesConfigurationClient _modulesConfigClient;

<style>
    .mud-table-cell-custom-group {
        font-weight: 700;text-align:left
    }

    .mud-table-cell-custom-group-footer {
        padding-bottom: 50px;
        text-align: right;
    }
</style>

<MudText  Class="ml-4" Typo="Typo.h6">Configuration</MudText>
<MudForm>
    <MudGrid>
        <MudItem xs = "3">
      <MudCheckBox @bind-Value="@Project.ReplicationEnabled">Duplication enabled</MudCheckBox>
      </MudItem>  <MudItem xs = "3">
     <MudTextField Class="ml-4" @bind-Value="@Project.HubGroup" Label="Duplication group" Variant="Variant.Text"></MudTextField>    
      </MudItem>  <MudItem xs = "3">
     <MudTextField Class="ml-4" @bind-Value="@Project.BlackBoardHostIP" Label="Black board IP address" Variant="Variant.Text"></MudTextField>
      </MudItem>  
</MudGrid>
</MudForm>

<hr />
<MudToolBar>
            <MudButton StartIcon="@Icons.Material.Filled.Refresh" IconColor="Color.Info" OnClick="RefreshStatus"> Refresh  </MudButton>  
    <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Filled.NewLabel" IconColor="Color.Warning" OnClick="CreateContainers" Disabled="@_shouldNotCreateContainers"> Create missing containers  </MudButton>      
        <MudButton StartIcon="@Icons.Material.Filled.Start" IconColor="Color.Success" OnClick="() => StartContainers()" Disabled="_canNotStartSelection">Start selection</MudButton>
        <MudButton StartIcon="@Icons.Material.Filled.Stop" IconColor="Color.Error" OnClick="() => StopContainers()" Disabled="_canNotStopSelection">Stop selection</MudButton> 
        <MudButton StartIcon="@Icons.Material.Filled.Delete" IconColor="Color.Dark" OnClick="() => DeleteContainers()" Disabled="_canNotDeleteContainers">Delete selection</MudButton> 
            <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Dark" OnClick="() => CheckForUpdates()">Check for updates</MudButton> 
        <MudButton StartIcon="@Icons.Material.Filled.Update" IconColor="Color.Dark" OnClick="() => UpdateSelection()">Update images</MudButton> 
    <MudSpacer />

</MudToolBar>
<hr />


@if(_status != null)
{
<MudTable   Class="mt-4"
          Hover="true" 
          Breakpoint="Breakpoint.Sm" 
          Height="1000px" 
          FixedHeader="true"
          Items="@_status.Items"
          GroupBy="@_groupDefinition"
          GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
          GroupFooterClass="mb-4"
          Dense="true"        
          MultiSelection="true"
          @ref="_tableRef"
          T="StandardSetUpStatusItem"
          SelectedItemsChanged="SelectionChanged">
              <ToolBarContent>
        <MudText Typo="Typo.h6">Containers</MudText></ToolBarContent>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Container</MudTh>
        <MudTh>Config ok</MudTh>
        <MudTh>Start/stop/Create</MudTh>
        <MudTh>Image status</MudTh>
    </HeaderContent>

    <GroupHeaderTemplate>
        <MudTh Class="mud-table-cell-custom-group" colspan="5" >@($"{context.Key}") </MudTh>
      
    </GroupHeaderTemplate>
    <RowTemplate>
        <MudTd DataLabel="Nr">@context.SetUpItem.ModuleDisplayName</MudTd>
        <MudTd DataLabel="Sign">@context.ContainerName</MudTd>
        <MudTd DataLabel="Name">@context.ConfigurationStatus()</MudTd>
        <MudTd DataLabel="Start/stop">
                @if (context.Started)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Stop" OnClick="() => _client.StopContainer(context.ContainerID)">Stop</MudButton>
                }
                else if (!string.IsNullOrEmpty(context.ContainerName))
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Start" OnClick="() => _client.StartContainer(context.ContainerID)">Start</MudButton>
                }
                else
                {
                    <MudButton StartIcon="@Icons.Material.Filled.NewLabel" OnClick="async () => 
                            {_modulesConfigClient.SaveStandardConfigToFile(context.SetUpItem); 
                                await _client.CreateStandardItemContainer(context.SetUpItem);}">
                                    Create
                    </MudButton>
                }
            </MudTd>
            <MudTd DataLabel="Image statis">
                @if(context.CurrentImageStatus == StandardSetUpStatusItem.ImageStatus.Updated)
                {
                    <MudBadge Color="Color.Success" Variant="Variant.Filled">Updated</MudBadge>
                }
                else if(context.CurrentImageStatus == StandardSetUpStatusItem.ImageStatus.Outdated)
                {
                    <MudBadge Color="Color.Warning" Variant="Variant.Filled">Outdated</MudBadge>
                }
                else
                {
                    <MudBadge Color="Color.Default" Variant="Variant.Filled">Unknown</MudBadge>
                }
            </MudTd>
    </RowTemplate>
      </MudTable>
}

@code {


    [Parameter]
    public DWISProject Project { get; set; } = new DWISProject();

    private MudTable<StandardSetUpStatusItem> _tableRef;
    private StandardSetUpStatus? _status => Project.Status;

    private bool _shouldNotCreateContainers = false;
    private bool _canNotStartSelection = false;
    private bool _canNotStopSelection = false;
    private bool _canNotDeleteContainers = false;

    private HashSet<StandardSetUpStatusItem>? _currentSelection;

    private HashSet<StandardSetUpStatusItem> selectedItems = new HashSet<StandardSetUpStatusItem>();

    private IEnumerable<string> SelectedContainers => selectedItems.Select(i => i.ContainerID);

    private TableGroupDefinition<StandardSetUpStatusItem> _groupDefinition = new()
    {
        GroupName = "Group",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (e) => e.SetUpItem.ModuleGroup
    };

    private void SelectionChanged(HashSet<StandardSetUpStatusItem> selectedItems)
    {
        _currentSelection = selectedItems;
        _canNotStartSelection = ! CheckCanStartSelection();
        _shouldNotCreateContainers = ! CheckShouldCreateContainers();
        _canNotStopSelection = ! CheckCanStopSelection();
        _canNotDeleteContainers = ! CheckCanDeleteSelection();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (_client != null && SetUp != null)
        {
            await  _client.UpdateStandardSetupImageDates(SetUp);
        }
        RefreshStatus();
    }



    private async void RefreshStatus()
    {
        Project.Status = await _client.UpdateStandardSetupStatus(SetUp, Project.ReplicationEnabled, Project.HubGroup);
        await InvokeAsync(StateHasChanged);
    }


    private bool CheckShouldCreateContainers()
    {
        var groups = _status.Items.GroupBy(i => i.SetUpItem.ModuleDisplayName);

        //too many selected from same group
        if(groups.Any(g => g.Count()==0 || (g.Count() == 1 && string.IsNullOrEmpty( g.First().ContainerName))))
        {
            return true;
        }
        return false;
    }

    private bool CheckCanStartSelection()
    {
        if(_currentSelection != null && _currentSelection.Count > 0)
        {
            if (_currentSelection.Any(i => string.IsNullOrEmpty( i.ContainerID)))
            {
                return false;    
            }


            var groups = _status.Items.GroupBy(i => i.SetUpItem.ModuleDisplayName);

            //too many selected from same group
            if(groups.Any(g => g.Count()>1))
            {
                return false;
            }

            if(_currentSelection.All(s => s.Started))
            {
                return false;
            }


            return true;
        }

        return false;    
    }

    private bool CheckCanStopSelection()
    {
        if(_currentSelection != null && _currentSelection.Count > 0)
        {      

            if(_currentSelection.All(s => !s.Started))
            {
                return false;
            }


            return true;
        }


        return false;
    }


    private bool CheckCanDeleteSelection()
    {
        if (_currentSelection != null && _currentSelection.Count > 0)
        {
            if (_currentSelection.Any(s => !string.IsNullOrEmpty(s.ContainerID)))
            {
                return true;
            }
            else
            {
                return false;
            }
        }
        return false;
    }

    private async Task StartContainers() {

        if(_currentSelection != null)
        {
            foreach(var item in _currentSelection)
            {
                if(!string.IsNullOrEmpty(item.ContainerID) && !item.Started)
                {
                    await  _client.StartContainer(item.ContainerID);
                }
            }
        }
        RefreshStatus();
        return; 
    }
    private async Task StopContainers() {   if(_currentSelection != null)
        {
            foreach(var item in _currentSelection)
            {
                if(!string.IsNullOrEmpty(item.ContainerID) && item.Started)
                {
                    await  _client.StopContainer(item.ContainerID);
                }
            }
        }
        RefreshStatus();
        return;
    }

    private async Task CreateContainers()
    {
        var toCreate = _status.Items.Where(i => string.IsNullOrEmpty(i.ContainerID));

        foreach (var item in toCreate)
        {
            if (item.SetUpItem.ConfigurationRequired)
            {
                _modulesConfigClient.SaveStandardConfigToFile(item.SetUpItem);
            }
            if (item.SetUpItem.ModuleDisplayName == "Default Blackboard")
            {
                await _client.CreateBlackboardContainer(Project.HubGroup, item.SetUpItem.DefaultContainerName, item.SetUpItem.BlackBoardPort);

            }
            else if (item.SetUpItem.ModuleDisplayName == "Local Blackboard")
            {
                await _client.CreateBlackboardContainer("", item.SetUpItem.DefaultContainerName, item.SetUpItem.BlackBoardPort);

            }
            else await _client.CreateStandardItemContainer(item.SetUpItem, Project.BlackBoardHostIP);

        }   
        RefreshStatus();
    }

    private async Task DeleteContainers() {
        if(_currentSelection != null)
        {
            foreach(var item in _currentSelection)
            {
                if(!string.IsNullOrEmpty(item.ContainerID))
                {
                    await  _client.DeleteContainer(item.ContainerID);
                }
            }
        }
        RefreshStatus();
        return; 
    }
    private async Task CheckForUpdates() {


        await _client.UpdateStandardSetupImageDates(SetUp);
        RefreshStatus();       
    }


    private async Task UpdateSelection() {
        if(_currentSelection != null)
        {
            await _client.UpdateStandardItemImages(_currentSelection);
            // foreach(var item in _currentSelection)
            // {
            //      await  _client.UpdateStandardItemImages(item);


            //     if(!string.IsNullOrEmpty(item.ContainerID))
            //     {
            //         await  _client.DeleteContainer(item.ContainerID);
            //     }
            // }
        }
        RefreshStatus();
        return; 
    }
}
