@using MudBlazor;
@using DWIS.Docker.Models;
@using DWIS.Docker.Clients;
@inject StandardSetUp SetUp;
@inject DWISDockerClient _client;
@inject DWISModulesConfigurationClient _modulesConfigClient;

<style>
    .mud-table-cell-custom-group {
        font-weight: 700;text-align:left
    }

    .mud-table-cell-custom-group-footer {
        padding-bottom: 50px;
        text-align: right;
    }
</style>


<MudToolBar>
            <MudButton StartIcon="@Icons.Material.Filled.Refresh" IconColor="Color.Info" OnClick="RefreshStatus"> Refresh  </MudButton>  
    <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Filled.NewLabel" IconColor="Color.Warning" OnClick="CreateContainers" Disabled="@_shouldNotCreateContainers"> Create missing containers  </MudButton>      
        <MudButton StartIcon="@Icons.Material.Filled.Start" IconColor="Color.Success" OnClick="() => StartContainers()" Disabled="_canNotStartSelection">Start all</MudButton>
        <MudButton StartIcon="@Icons.Material.Filled.Stop" IconColor="Color.Error" OnClick="() => StopContainers()" Disabled="_canNotStopSelection">Stop all</MudButton> 
    <MudSpacer />
    <MudCheckBox @bind-Value="@SetUp.DuplicationEnabled">Duplication enabled</MudCheckBox>
     <MudTextField Class="ml-4" @bind-Value="@SetUp.HubGroup" Label="Duplication group" Variant="Variant.Text"></MudTextField>
</MudToolBar>




@if(_status != null)
{
<MudTable Class="mt-4"
          Hover="true" 
          Breakpoint="Breakpoint.Sm" 
          Height="1000px" 
          FixedHeader="true"
          Items="@_status.Items"
          GroupBy="@_groupDefinition"
          GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
          GroupFooterClass="mb-4"
          Dense="true"        
          MultiSelection="true"
          @ref="_tableRef"
          T="StandardSetUpStatusItem"
          SelectedItemsChanged="SelectionChanged">

    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Container</MudTh>
        <MudTh>Config ok</MudTh>
        <MudTh>Start/stop/Create</MudTh>
    </HeaderContent>

    <GroupHeaderTemplate>
        <MudTh Class="mud-table-cell-custom-group" colspan="4" >@($"{context.Key}") </MudTh>
      
    </GroupHeaderTemplate>
    <RowTemplate>
        <MudTd DataLabel="Nr">@context.SetUpItem.ModuleDisplayName</MudTd>
        <MudTd DataLabel="Sign">@context.ContainerName</MudTd>
        <MudTd DataLabel="Name">@context.ConfigurationStatus()</MudTd>
        <MudTd DataLabel="Start/stop">
                @if (context.Started)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Stop" OnClick="() => _client.StopContainer(context.ID)">Stop</MudButton>
                }
                else if (!string.IsNullOrEmpty(context.ContainerName))
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Start" OnClick="() => _client.StartContainer(context.ID)">Start</MudButton>
                }
                else
                {
                    <MudButton StartIcon="@Icons.Material.Filled.NewLabel" OnClick="async () => 
                            {_modulesConfigClient.SaveStandardConfigToFile(context.SetUpItem); 
                                await _client.CreateStandardItemContainer(context.SetUpItem);}">
                                    Create
                    </MudButton>
                }
            </MudTd>
    </RowTemplate>
      </MudTable>
}

@code {


    

    private MudTable<StandardSetUpStatusItem> _tableRef;
    private StandardSetUpStatus _status;

    private bool _shouldNotCreateContainers = false;
    private bool _canNotStartSelection = false;
    private bool _canNotStopSelection = false;

    private HashSet<StandardSetUpStatusItem>? _currentSelection;

    private HashSet<StandardSetUpStatusItem> selectedItems = new HashSet<StandardSetUpStatusItem>();

    private IEnumerable<string> SelectedContainers => selectedItems.Select(i => i.ID);

    private TableGroupDefinition<StandardSetUpStatusItem> _groupDefinition = new()
    {
        GroupName = "Group",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (e) => e.SetUpItem.ModuleGroup
    };

    private void SelectionChanged(HashSet<StandardSetUpStatusItem> selectedItems)
    {
        _currentSelection = selectedItems;
        _canNotStartSelection = ! CheckCanStartSelection();
        _shouldNotCreateContainers = ! CheckShouldCreateContainers();
        _canNotStopSelection = ! CheckCanStopSelection();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        RefreshStatus();
    }



    private async void RefreshStatus()
    {
        _status = await _client.UpdateStandardSetupStatus(SetUp);

        await InvokeAsync(StateHasChanged);
    }


    private bool CheckShouldCreateContainers()
    {
        var groups = _status.Items.GroupBy(i => i.SetUpItem.ModuleDisplayName);

        //too many selected from same group
        if(groups.Any(g => g.Count()==0))
        {
            return true;
        }
        return false;
    }

    private bool CheckCanStartSelection()
    {
        if(_currentSelection != null && _currentSelection.Count > 0)
        {
            if (_currentSelection.Any(i => string.IsNullOrEmpty( i.ID)))
            {
                return false;    
            }


            var groups = _status.Items.GroupBy(i => i.SetUpItem.ModuleDisplayName);

            //too many selected from same group
            if(groups.Any(g => g.Count()>1))
            {
                return false;
            }

            if(_currentSelection.All(s => s.Started))
            {
                return false;
            }


            return true;
        }

        return false;    
    }

    private bool CheckCanStopSelection()
    {
        if(_currentSelection != null && _currentSelection.Count > 0)
        {      

            if(_currentSelection.All(s => !s.Started))
            {
                return false;
            }


            return true;
        }


        return false;
    }


    private async Task StartContainers() {

        if(_currentSelection != null)
        {
            foreach(var item in _currentSelection)
            {
                if(!string.IsNullOrEmpty(item.ID) && !item.Started)
                {
                    await  _client.StartContainer(item.ID);
                }
            }
        }
        RefreshStatus();
        return; 
    }
    private async Task StopContainers() {   if(_currentSelection != null)
        {
            foreach(var item in _currentSelection)
            {
                if(!string.IsNullOrEmpty(item.ID) && item.Started)
                {
                    await  _client.StopContainer(item.ID);
                }
            }
        }
        RefreshStatus();
        return;
    }
    private async Task CreateContainers()
    {
        var toCreate = _status.Items.Where(i => string.IsNullOrEmpty(i.ID));

        foreach (var item in toCreate)
        {
            if (item.SetUpItem.ConfigurationRequired)
            {
                _modulesConfigClient.SaveStandardConfigToFile(item.SetUpItem);
            }
            if (item.SetUpItem.ModuleDisplayName == "Default Blackboard")
            {
                await _client.CreateBlackboardContainer(SetUp.HubGroup, item.SetUpItem.DefaultContainerName, item.SetUpItem.BlackBoardPort);

            }else if (item.SetUpItem.ModuleDisplayName == "Local Blackboard")
            {
                await _client.CreateBlackboardContainer("", item.SetUpItem.DefaultContainerName, item.SetUpItem.BlackBoardPort);

            }
            else await _client.CreateStandardItemContainer(item.SetUpItem);
        
        }   
        RefreshStatus();
    }
}
