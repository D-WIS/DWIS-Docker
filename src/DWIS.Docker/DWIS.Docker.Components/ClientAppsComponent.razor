@using MudBlazor;
@using DWIS.Docker.Models;
@using DWIS.Docker.Clients;
@inject DWISProject Project;
@inject DWISDockerClient DockerClient;


<MudTable Items="Project.Clients.Apps" T="DWISApp">
    <HeaderContent>
        <MudTh>App</MudTh>
        <MudTh>Image</MudTh>
        <MudTh>Start / stop</MudTh>
        <MudTh>Port</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd>
            <MudTextField @bind-Value="@context.AppName" Label="Container name"></MudTextField>          
        </MudTd>
        <MudTd>@context.ImageNameNoTag</MudTd>
        <MudTd>
            @if (context.Running)
            {
                <MudButton StartIcon="@Icons.Material.Filled.Stop" OnClick="async () =>await Stop(context)"></MudButton>
            }
            else
            {
                <MudButton StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="async () => await Start(context)"></MudButton>
            }
        </MudTd>
        <MudTd>
            <MudLink Target="_blank" Href=@GetAddress(context)>
                <MudTextField @bind-Value="@context.HostPort" Label="Port"></MudTextField>
               
                </MudLink>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {


    private string GetAddress(DWISApp app){
        return "http://localhost:" + app.HostPort;
    }

    protected async override Task OnInitializedAsync()
    {
        if (DockerClient != null)
        {
            foreach (var app in Project.Clients.Apps)
            {
                var info = await DockerClient.GetContainers(app.ImageNameNoTag + ":" + app.ImageTag);
                if (info != default && info.Any())
                {
                    app.ContainerID = info.First().id;
                    app.Running = info.First().running;  
                    app.AppName = info.First().name;
                }
            }
        }
        base.OnInitializedAsync();    
    }

    private async Task Stop(DWISApp app)
    {
        await DockerClient.StopContainer(app.ContainerID);
        app.Running = false;
    }
    private async Task Start(DWISApp app)
    {
        if (string.IsNullOrEmpty(app.ContainerID))
        {
            var envVariables = new List<(string key, string val)>
                {
                    (DWIS.Client.ReferenceImplementation.IDWISClientConfiguration.BLACKBOARD_IP_ENVIRONMENT_VARIABLE, "host.docker.internal")
                };

            if (!string.IsNullOrEmpty(app.HostPort))
            {
                app.ContainerID = await DockerClient.CreateContainer(app.ImageNameNoTag, app.ImageTag, null, null, app.AppName.Trim().Replace(" ", "-"), envVariables: envVariables, portsMapping: [(app.HostPort, app.ContainerPort)]);
            }
            else
            {
                app.ContainerID = await DockerClient.CreateContainer(app.ImageNameNoTag, app.ImageTag, null, null, app.AppName.Trim().Replace(" ", "-"), envVariables: envVariables);
            }
        }


        await DockerClient.StartContainer(app.ContainerID);
        app.Running = true;
    }

}
